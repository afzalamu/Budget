<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Budget Tracker</title>
  <style>
    /* -----------------------------------
       1. Base Color Variables (LIGHT Theme Default)
       ----------------------------------- */
    :root{
      --bg: #f7f7f7;
      --card: #fff;
      --text: #222;
      --accent: #007bff;
      --danger: #dc3545;
      --success: #28a745;
      --muted: #666;
      --border: #ddd;
      --shadow-color: rgba(0,0,0,0.1);
    }

    /* -----------------------------------
       2. Dark Mode Overrides
       ----------------------------------- */
    body.dark-mode {
      --bg: #1a1a2e; /* Deep Background */
      --card: #2c2c44; /* Card Background */
      --text: #e0e0e0; /* Light Text */
      --accent: #5e64ff; /* Primary Blue/Purple */
      --danger: #ff497c; /* Danger Pink */
      --success: #3be982; /* Success Green */
      --muted: #a0a0c0; /* Muted Text */
      --border: #404060; /* Border Color */
      --shadow-color: rgba(0,0,0,0.5);
    }

    /* -----------------------------------
       3. General & Layout Styling
       ----------------------------------- */
    *{box-sizing:border-box}
    body {
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial;
      background: var(--bg);
      margin: 0;
      padding: 10px;
      color: var(--text);
      transition: background 0.3s, color 0.3s;
    }
    .container {
      max-width: 900px;
      margin: 10px auto;
      background: var(--card);
      padding: 18px;
      border-radius: 12px;
      box-shadow: 0 10px 30px var(--shadow-color); 
      transition: background 0.3s, box-shadow 0.3s;
    }
    
    /* Du'a Styling */
    .dua {
        text-align: center;
        font-size: 16px;
        font-weight: 600;
        margin-top: 5px;
        margin-bottom: 15px;
        color: var(--success);
    }
    
    h3 { margin-top: 20px; font-size: 18px; color: var(--accent); }
    .section { 
        margin: 16px 0; 
        padding: 15px; 
        border: 1px solid var(--border); 
        border-radius: 10px;
        background: var(--card);
        transition: background 0.3s, border-color 0.3s;
    }
    body.dark-mode .section {
        background: #363650;
    }

    label { display:block; margin-top:8px; font-weight:600; font-size: 14px; }
    input, select, button { 
      padding: 12px;
      border-radius:8px; 
      border:1px solid var(--border); 
      width:100%;
      margin-top:6px; 
      font-size: 14px;
      background: var(--card); 
      color: var(--text);
      transition: background 0.3s, color 0.3s, border-color 0.3s;
    }
    
    /* Hide Number Input Spinners */
    input[type=number]::-webkit-outer-spin-button,
    input[type=number]::-webkit-inner-spin-button {
      -webkit-appearance: none;
      margin: 0;
    }
    input[type=number] {
      -moz-appearance: textfield;
    }
    
    .btn-row{ display:flex; gap:10px; margin-top:12px; }
    button{ 
        background:var(--accent); 
        color:white; 
        border:0; 
        cursor:pointer; 
        font-weight:600; 
        transition: background-color 0.3s, transform 0.1s; 
    }
    button:hover{ filter:brightness(1.2); transform: translateY(-1px); }
    button.danger{ background:var(--danger); }
    button.success{ background:var(--success); }
    
    .muted{ color:var(--muted); font-size:14px; margin-top:8px; }
    
    /* Responsive Table Wrapper */
    .table-responsive {
        overflow-x: auto;
        width: 100%;
        -webkit-overflow-scrolling: touch;
    }
    table { 
        width: 100%; 
        min-width: 600px; 
        border-collapse:collapse; 
        margin-top:12px; 
    }
    table th { 
        background: var(--accent); 
        color: #fff; 
        font-weight:600; 
    }
    table th, table td { 
        border:1px solid var(--border); 
        padding:8px; 
        text-align:center; 
        font-size:12px; 
    }
    
    /* Allocation Edit Button */
    .edit-allocation-btn {
        background: none;
        color: var(--muted);
        border: 1px solid var(--muted);
        padding: 4px 8px;
        font-size: 12px;
        width: auto;
        margin-left: 10px;
        transition: all 0.3s;
    }
    .edit-allocation-btn:hover {
        background: var(--accent);
        color: white;
        border-color: var(--accent);
    }

    /* Chart Styling: Ensures chart content is centered */
    .chart-container {
        display: flex;
        justify-content: center;
        align-items: center;
        flex-direction: column;
        margin-top: 20px;
        margin-left: auto;
        margin-right: auto;
    }
    #categoryChart, #dailyChart {
        max-width: 100%;
        height: auto;
    }

    /* Modal Styling */
    .modal {
      display: none;
      position: fixed;
      z-index: 100;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      overflow: auto;
      background-color: rgba(0,0,0,0.6);
      padding-top: 20px;
    }
    .modal-content {
      background-color: var(--card);
      margin: 10% auto; 
      padding: 25px;
      border: 1px solid var(--border);
      width: 95%; 
      max-width: 500px;
      border-radius: 12px;
      box-shadow: 0 10px 30px var(--shadow-color);
      transition: background 0.3s, border-color 0.3s;
    }
    .close { color: var(--danger); }
    
    /* Theme Toggle Switch */
    .theme-toggle-container {
        display: flex;
        justify-content: center;
        align-items: center;
        margin-bottom: 10px;
        padding: 5px;
        background: var(--card);
        border-radius: 8px;
    }
    .theme-toggle-container label {
        display: flex;
        align-items: center;
        cursor: pointer;
        font-size: 14px;
        font-weight: normal;
        margin: 0;
    }
    .theme-switch {
        position: relative;
        display: inline-block;
        width: 40px;
        height: 24px;
        margin: 0 10px;
    }
    .theme-switch input {
        opacity: 0;
        width: 0;
        height: 0;
    }
    .slider {
        position: absolute;
        cursor: pointer;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: var(--muted);
        transition: .4s;
        border-radius: 24px;
    }
    .slider:before {
        position: absolute;
        content: "";
        height: 16px;
        width: 16px;
        left: 4px;
        bottom: 4px;
        background-color: white;
        transition: .4s;
        border-radius: 50%;
    }
    /* State changes */
    input:checked + .slider {
        background-color: var(--accent);
    }
    input:checked + .slider:before {
        transform: translateX(16px);
    }

    /* -----------------------------------
       4. MEDIA QUERIES (Desktop/Tablet Layout)
       ----------------------------------- */
    @media (min-width: 700px) {
        /* TOP GRID: Allocations + Add Expense */
        .main-content-grid {
            display: grid;
            grid-template-columns: 1fr 1fr; /* Two equal columns */
            gap: 20px;
            margin-bottom: 16px;
        }
        
        /* BOTTOM GRID: Chart + History */
        .table-and-chart-grid {
            display: grid;
            grid-template-columns: 45% 55%; 
            gap: 20px;
            margin-bottom: 16px;
        }

        .section {
            margin: 0; 
        }
        
        /* Ensures chart content is tightly packed and centered */
        .chart-container {
            max-width: 100%; 
            margin-left: auto;
            margin-right: auto;
        }
        #categoryChart {
            max-width: 350px; 
        }
    }

    /* -----------------------------------
       5. MEDIA QUERIES (Mobile Layout)
       ----------------------------------- */
    @media (max-width:700px){
      .btn-row{ flex-direction:column; }
      .container { padding: 10px; }
      .modal-content { margin: 5% auto; } 
    }
  </style>
</head>
<body>
  <div class="container">
    
    <div class="theme-toggle-container">
        <label for="themeToggle">â˜€ï¸ Light Mode</label>
        <div class="theme-switch">
            <input type="checkbox" id="themeToggle">
            <span class="slider"></span>
        </div>
        <label for="themeToggle">ğŸŒ™ Dark Mode</label>
    </div>

    <p id="topDuaDisplay" class="dua">
        </p>

    <section class="section">
      <label for="total">Enter Total Monthly Income:</label>
      <input type="number" id="total" placeholder="Enter amount (e.g. 50000)">
      <div class="btn-row">
        <button id="saveIncome">Save Income</button>
      </div>
      <div class="btn-row">
        <input type="file" id="importFile" accept=".json" style="display:none;">
        <button id="importData" class="success">Import Data</button>
        <button id="exportData" class="success">Export Data</button>
        <button id="exportCsv" class="success">Export to CSV</button> 
      </div>
    </section>

    <div class="main-content-grid">
        <section class="section">
          <h3>Allocations ğŸ’° 
            <button id="editAllocations" class="edit-allocation-btn">Edit Percentages</button>
          </h3>
          
          <p id="needs">Needs: â‚¹0 (Remaining: â‚¹0)</p>
          <p id="wants">Wants: â‚¹0 (Remaining: â‚¹0)</p>
          <p id="savings">Savings: â‚¹0 (Current Saved: â‚¹0)</p>
          
          <p id="totalSummary" class="muted">Total Income: â‚¹0 â€¢ Total Spent: â‚¹0 â€¢ Remaining: â‚¹0 â€¢ Savings Rate: 0%</p>
        </section>

        <section class="section">
          <h3>Add Expense</h3>

          <label for="expense-section">Budget Section (50/30/20):</label>
          <select id="expense-section">
            <option value="needs">Needs (50%)</option>
            <option value="wants">Wants (30%)</option>
            <option value="savings">Savings (20%)</option>
          </select>
          
          <div style="display: flex; justify-content: space-between; align-items: flex-end;">
              <label for="expense-category" style="margin-bottom: 0;">Sub-Category:</label>
              <button id="manageCategoriesBtn" class="edit-allocation-btn" style="width: auto; margin-top: 0;">Manage Categories</button>
          </div>
          <select id="expense-category"></select>

          <label for="expense-amount">Amount:</label>
          <input type="number" id="expense-amount" placeholder="Amount spent">

          <label for="expense-date">Date:</label>
          <input type="date" id="expense-date">

          <label for="expense-note">Note:</label>
          <input type="text" id="expense-note" placeholder="optional">

          <div class="btn-row">
            <button id="add-expense">Add Expense</button>
          </div>
        </section>
    </div>
    <section class="section">
        <h3>Weekly Spending Trend ğŸ“Š</h3>
        <p class="muted">Net daily expenditure (Needs, Wants, & Savings Withdrawals) over the last 7 days.</p>
        <div class="chart-container">
            <canvas id="dailyChart"></canvas>
        </div>
    </section>

    <div class="table-and-chart-grid">
        <section class="section">
            <h3>Category Spending Chart ğŸ“ˆ</h3>
            <p class="muted">Monthly total categorized expenditures.</p>
            <div class="chart-container">
                <canvas id="categoryChart"></canvas>
            </div>
        </section>

        <section class="section">
          <h3>Expense History</h3>
          <div class="table-responsive">
            <table id="expense-table">
              <thead>
                <tr>
                  <th>Date</th>
                  <th>Section</th>
                  <th>Category</th>
                  <th>Amount</th>
                  <th>Note</th>
                  <th></th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </section>
    </div>
    <section class="section">
        <h3>Past Month History ğŸ“œ</h3>
        <div class="table-responsive">
            <table id="history-table">
                <thead>
                    <tr>
                        <th>Month</th>
                        <th>Income</th>
                        <th>Spent (N/W/S)</th>
                        <th>Net Savings</th>
                        <th>Savings Rate</th>
                    </tr>
                </thead>
                <tbody id="history-table-body">
                    </tbody>
            </table>
        </div>
        <div class="btn-row">
             <button id="archiveMonth" class="success">Archive Month & Reset</button>
        </div>
    </section>

    <section class="section">
        <h3>How to Use This Tracker: A Simple Guide</h3>
        <p>This tracker helps you maintain a balanced budget by adhering to Islamic principles of moderation (avoiding extravagance and miserliness).</p>
        
        <ol>
            <li><strong>Setup:</strong> Enter your total monthly income and click 'Save Income'. Optionally, use 'Edit Percentages' to customize your 50/30/20 split.</li>
            
            <li><strong>Manage Categories:</strong> Use the 'Manage Categories' button to add or delete custom sub-categories (e.g., 'Subscriptions', 'Car Fund') that fit your life.</li>
            
            <li><strong>Log Transactions:</strong> Use the 'Add Expense' form for *every* spending transaction.
                <ul>
                    <li>For **Needs** or **Wants**, enter the amount spent (e.g., â‚¹500).</li>
                    <li>For **Savings**, enter the amount withdrawn (e.g., â‚¹1,000 withdrawal from 'Emergency Fund' will automatically be recorded as a negative withdrawal).</li>
                </ul>
            </li>
            
            <li><strong>Review Summary:</strong> The Allocations section updates instantly, showing you the exact remaining budget for Needs and Wants, and your total 'Current Saved' amount.</li>
            
            <li><strong>End of Month Procedure (Archive & Export):</strong>
                <ul>
                    <li>Click <strong>Export to CSV</strong>: This saves a complete, date-stamped file of your summary and detailed history to your computer (ready for Excel).</li>
                    <li>Click <strong>Archive Month & Reset</strong>: This moves the current month's final summary into the 'Past Month History' table and clears the transaction history, preparing the tracker for the next month.</li>
                </ul>
            </li>
        </ol>
    </section>
    
    <section class="section" style="border: none; padding-bottom: 0;">
        <button id="clearAll" class="danger">Clear All Data (Everything)</button>
    </section>
  </div>
  
  <div id="allocationModal" class="modal">
    <div class="modal-content">
      <span class="close" id="closeAllocationModal">&times;</span>
      <h3>Edit Allocation Percentages</h3>
      <p class="muted">The total must equal 100%.</p>
      <label for="needs-percent">Needs (%):</label>
      <input type="number" id="needs-percent" min="0" max="100">
      
      <label for="wants-percent">Wants (%):</label>
      <input type="number" id="wants-percent" min="0" max="100">
      
      <label for="savings-percent">Savings (%):</label>
      <input type="number" id="savings-percent" min="0" max="100">
      
      <button id="savePercentages" style="margin-top: 15px;">Save Percentages</button>
    </div>
  </div>

  <div id="categoryModal" class="modal">
    <div class="modal-content">
      <span class="close" id="closeCategoryModal">&times;</span>
      <h3>Manage Sub-Categories</h3>

      <div style="margin-top: 15px;">
        <label for="new-category-name">Add New Category:</label>
        <input type="text" id="new-category-name" placeholder="Category Name">
        <button id="addCategoryBtn" class="success" style="margin-top: 8px;">Add Category</button>
      </div>

      <h4 style="margin-top: 20px; border-bottom: 1px solid var(--border); padding-bottom: 5px;">Current Categories:</h4>
      <div id="currentCategoryList">
        </div>
    </div>
  </div>
  
  <script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.js"></script>

  <script>
    const KEY_EXP = 'budget_expenses_v15';
    const KEY_INC = 'budget_totalIncome_v15';
    const KEY_ALLOC = 'budget_allocations_v15';
    const KEY_CATEGORIES = 'budget_categories_v15';
    const KEY_THEME = 'budget_theme_v1';
    const KEY_HISTORY = 'budget_history_v1';

    // 20 Du'as related to Rizq, Barakah, and Sufficiency
    const ROTATING_DUAS = [
        { arabic: "Ø§Ù„Ù„ÙÙ‘Ù‡ÙÙ…ÙÙ‘ Ø¥ÙÙ†ÙÙ‘ÙŠ Ø£ÙØ³Ù’Ø£ÙÙ„ÙÙƒÙ Ø¹ÙÙ„Ù’Ù…Ù‹Ø§ Ù†ÙØ§ÙÙØ¹Ù‹Ø§ ÙˆÙØ±ÙØ²Ù’Ù‚Ù‹Ø§ Ø·ÙÙŠÙÙ‘Ø¨Ù‹Ø§ ÙˆÙØ¹ÙÙ…ÙÙ„Ù‹Ø§ Ù…ÙØªÙÙ‚ÙØ¨ÙÙ‘Ù„Ø§Ù‹", translation: "O Allah, I ask You for beneficial knowledge, pure provision, and accepted deeds." },
        { arabic: "Ø§Ù„Ù„Ù‘Ù‡ÙÙ…ÙÙ‘ Ø§ÙƒÙ’ÙÙÙ†ÙÙŠ Ø¨ÙØ­ÙÙ„Ø§Ù„ÙÙƒÙ Ø¹ÙÙ†Ù’ Ø­ÙØ±ÙØ§Ù…ÙÙƒÙ ÙˆÙØ£ÙØºÙ’Ù†ÙÙ†ÙÙŠ Ø¨ÙÙÙØ¶Ù’Ù„ÙÙƒÙ Ø¹ÙÙ…ÙÙ‘Ù†Ù’ Ø³ÙÙˆÙØ§ÙƒÙ", translation: "O Allah, suffice me with Your lawful provision instead of Your unlawful, and make me independent of anyone besides You by Your Grace." },
        { arabic: "Ø§Ù„Ù„ÙÙ‘Ù‡ÙÙ…ÙÙ‘ Ø§ØºÙ’ÙÙØ±Ù’ Ù„ÙÙŠ ÙˆÙØ§Ø±Ù’Ø­ÙÙ…Ù’Ù†ÙÙŠ ÙˆÙØ§Ù‡Ù’Ø¯ÙÙ†ÙÙŠ ÙˆÙØ¹ÙØ§ÙÙÙ†ÙÙŠ ÙˆÙØ§Ø±Ù’Ø²ÙÙ‚Ù’Ù†ÙÙŠ", translation: "O Allah! Forgive me, have mercy on me, guide me, guard me against harm, and provide me with sustenance (Rizq)." },
        { arabic: "Ø±ÙØ¨ÙÙ‘ Ø¥ÙÙ†ÙÙ‘ÙŠ Ù„ÙÙ…ÙØ§ Ø£ÙÙ†Ø²ÙÙ„Ù’ØªÙ Ø¥ÙÙ„ÙÙŠÙÙ‘ Ù…ÙÙ†Ù’ Ø®ÙÙŠÙ’Ø±Ù ÙÙÙ‚ÙÙŠØ±ÙŒ", translation: "My Lord! I am truly in need of whatever good You may send down to me." },
        { arabic: "Ø±ÙØ¨ÙÙ‘Ù†ÙØ¢ Ø¡ÙØ§ØªÙÙ†ÙØ§ ÙÙÙ‰ Ù±Ù„Ø¯ÙÙ‘Ù†Ù’ÙŠÙØ§ Ø­ÙØ³ÙÙ†ÙØ©Ù‹ ÙˆÙÙÙÙ‰ Ù±Ù„Ù’Ù€ÙÙ”Ø§Ø®ÙØ±ÙØ©Ù Ø­ÙØ³ÙÙ†ÙØ©Ù‹ ÙˆÙÙ‚ÙÙ†ÙØ§ Ø¹ÙØ°ÙØ§Ø¨Ù Ù±Ù„Ù†ÙÙ‘Ø§Ø±Ù", translation: "Our Lord, give us in this world [that which is] good and in the Hereafter [that which is] good and protect us from the punishment of the Fire." },
        { arabic: "Ø§Ù„Ù„ÙÙ‘Ù‡ÙÙ…ÙÙ‘ Ø¥ÙÙ†ÙÙ‘ÙŠ Ø£ÙØ¹ÙÙˆØ°Ù Ø¨ÙÙƒÙ Ù…ÙÙ†Ù’ Ø§Ù„Ù’Ù‡ÙÙ…ÙÙ‘ ÙˆÙØ§Ù„Ù’Ø­ÙØ²ÙÙ†Ù ÙˆÙØ§Ù„Ù’Ø¹ÙØ¬Ù’Ø²Ù ÙˆÙØ§Ù„Ù’ÙƒÙØ³ÙÙ„Ù ÙˆÙØ§Ù„Ù’Ø¬ÙØ¨Ù’Ù†Ù ÙˆÙØ§Ù„Ù’Ø¨ÙØ®Ù’Ù„Ù ÙˆÙØ¶ÙÙ„ÙØ¹Ù Ø§Ù„Ø¯ÙÙ‘ÙŠÙ’Ù†Ù ÙˆÙØºÙÙ„ÙØ¨ÙØ©Ù Ø§Ù„Ø±ÙÙ‘Ø¬ÙØ§Ù„Ù", translation: "O Allah, I seek refuge in You from anxiety and sorrow, weakness and laziness, miserliness and cowardice, the burden of debts and from being overpowered by men." },
        { arabic: "Ø§Ù„Ù„ÙÙ‘Ù‡ÙÙ…ÙÙ‘ Ø¨ÙØ§Ø±ÙÙƒÙ’ Ù„ÙÙ†ÙØ§ ÙÙÙŠÙ…ÙØ§ Ø±ÙØ²ÙÙ‚Ù’ØªÙÙ†ÙØ§ ÙˆÙÙ‚ÙÙ†ÙØ§ Ø¹ÙØ°ÙØ§Ø¨Ù Ø§Ù„Ù†ÙÙ‘Ø§Ø±Ù", translation: "O Allah! Bless us in what You have provided us with and protect us from the punishment of the Fire." },
        { arabic: "Ø§Ù„Ù„ÙÙ‘Ù‡ÙÙ…ÙÙ‘ Ø£ÙÙƒÙ’Ø«ÙØ±Ù’ Ù…ÙØ§Ù„ÙÙŠ ÙˆÙÙˆÙÙ„ÙØ¯ÙÙŠØŒ ÙˆÙØ¨ÙØ§Ø±ÙÙƒÙ’ Ù„ÙÙŠ ÙÙÙŠÙ…ÙØ§ Ø£ÙØ¹Ù’Ø·ÙÙŠÙ’ØªÙÙ†ÙÙŠ", translation: "O Allah, increase my wealth and children, and bless me in what You have given me." },
        { arabic: "Ø§Ù„Ù„ÙÙ‘Ù‡ÙÙ…ÙÙ‘ Ø§Ø¬Ù’Ø¹ÙÙ„Ù’ Ø£ÙÙˆÙ’Ø³ÙØ¹Ù Ø±ÙØ²Ù’Ù‚ÙÙƒÙ Ø¹ÙÙ„ÙÙŠÙÙ‘ Ø¹ÙÙ†Ù’Ø¯Ù ÙƒÙØ¨ÙØ±Ù Ø³ÙÙ†ÙÙ‘ÙŠ", translation: "O Allah, make the most ample provision You grant me be when I am old." },
        { arabic: "Ø§Ù„Ù„ÙÙ‘Ù‡ÙÙ…ÙÙ‘ Ù„ÙØ§ Ù…ÙØ§Ù†ÙØ¹Ù Ù„ÙÙ…ÙØ§ Ø£ÙØ¹Ù’Ø·ÙÙŠÙ’ØªÙØŒ ÙˆÙÙ„ÙØ§ Ù…ÙØ¹Ù’Ø·ÙÙŠÙ Ù„ÙÙ…ÙØ§ Ù…ÙÙ†ÙØ¹Ù’ØªÙ", translation: "O Allah, none can withhold what You give, and none can give what You withhold." },
        { arabic: "ÙŠÙØ§ Ù…ÙØ§Ù„ÙÙƒÙ Ø§Ù„Ù’Ù…ÙÙ„Ù’ÙƒÙ ØªÙØ¤Ù’ØªÙÙŠ Ø§Ù„Ù’Ù…ÙÙ„Ù’ÙƒÙ Ù…ÙÙ† ØªÙØ´ÙØ§Ø¡Ù ÙˆÙØªÙÙ†Ø²ÙØ¹Ù Ø§Ù„Ù’Ù…ÙÙ„Ù’ÙƒÙ Ù…ÙÙ…ÙÙ‘Ù† ØªÙØ´ÙØ§Ø¡Ù", translation: "O Owner of the Dominion, You give dominion to whom You will and You take dominion from whom You will." },
        { arabic: "Ø§Ù„Ù„ÙÙ‘Ù‡ÙÙ…ÙÙ‘ Ø¥ÙÙ†ÙÙ‘ÙŠ Ø£ÙØ³Ù’Ø£ÙÙ„ÙÙƒÙ Ù…ÙÙ†Ù’ ÙÙØ¶Ù’Ù„ÙÙƒÙ", translation: "O Allah, I ask for Your favor." },
        { arabic: "Ø­ÙØ³Ù’Ø¨ÙÙ†ÙØ§ Ø§Ù„Ù„ÙÙ‘Ù‡Ù ÙˆÙÙ†ÙØ¹Ù’Ù…Ù Ø§Ù„Ù’ÙˆÙÙƒÙÙŠÙ„Ù", translation: "Sufficient for us is Allah, and [He is] the best Disposer of affairs." },
        { arabic: "Ø§Ù„Ù„ÙÙ‘Ù‡ÙÙ…ÙÙ‘ Ø¥ÙÙ†ÙÙ‘ÙŠ Ø£ÙØ¹ÙÙˆØ°Ù Ø¨ÙÙƒÙ Ù…ÙÙ†Ù Ø§Ù„Ù’ÙÙÙ‚Ù’Ø±ÙØŒ ÙˆÙØ§Ù„Ù’Ù‚ÙÙ„ÙÙ‘Ø©ÙØŒ ÙˆÙØ§Ù„Ø°ÙÙ‘Ù„ÙÙ‘Ø©Ù", translation: "O Allah, I seek refuge in You from poverty, scarcity, and humiliation." },
        { arabic: "Ø§Ù„Ù„ÙÙ‘Ù‡ÙÙ…ÙÙ‘ Ø§Ø¬Ù’Ø¹ÙÙ„Ù’ Ø±ÙØ²Ù’Ù‚ÙÙŠ Ø±ÙØºÙØ¯Ù‹Ø§", translation: "O Allah, make my provision ample." },
        { arabic: "Ø§Ù„Ù„ÙÙ‘Ù‡ÙÙ…ÙÙ‘ Ø¨ÙØ§Ø±ÙÙƒÙ’ Ù„ÙÙ†ÙØ§ ÙÙÙŠ Ø±ÙØ²Ù’Ù‚ÙÙ†ÙØ§", translation: "O Allah, bless us in our provision." },
        { arabic: "ÙˆÙÙ…ÙÙ† ÙŠÙØªÙÙ‘Ù‚Ù Ø§Ù„Ù„ÙÙ‘Ù‡Ù ÙŠÙØ¬Ù’Ø¹ÙÙ„ Ù„ÙÙ‘Ù‡Ù Ù…ÙØ®Ù’Ø±ÙØ¬Ù‹Ø§ ÙˆÙÙŠÙØ±Ù’Ø²ÙÙ‚Ù’Ù‡Ù Ù…ÙÙ†Ù’ Ø­ÙÙŠÙ’Ø«Ù Ù„ÙØ§ ÙŠÙØ­Ù’ØªÙØ³ÙØ¨Ù", translation: "And whoever fears Allahâ€”He will make for him a way out and will provide for him from where he does not expect." },
        { arabic: "Ø§Ù„Ù„ÙÙ‘Ù‡ÙÙ…ÙÙ‘ Ø£ÙØ¹ÙÙ†ÙÙ‘ÙŠ Ø¹ÙÙ„ÙÙ‰ Ø´ÙÙƒÙ’Ø±ÙÙƒÙ ÙˆÙØ­ÙØ³Ù’Ù†Ù Ø¹ÙØ¨ÙØ§Ø¯ÙØªÙÙƒÙ", translation: "O Allah, help me to remember You, to thank You, and to worship You in the best of manners." },
        { arabic: "Ø§Ù„Ù„ÙÙ‘Ù‡ÙÙ…ÙÙ‘ Ø¥ÙÙ†ÙÙ‘ÙŠ Ø£ÙØ³Ù’Ø£ÙÙ„ÙÙƒÙ Ø§Ù„Ù’ØºÙÙ†ÙÙ‰ ÙˆÙØ§Ù„ØªÙÙ‘Ù‚ÙÙ‰ ÙˆÙØ§Ù„Ù’Ù‡ÙØ¯ÙÙ‰", translation: "O Allah, I ask You for wealth, righteousness, and guidance." },
        { arabic: "Ø§Ù„Ù„ÙÙ‘Ù‡ÙÙ…ÙÙ‘ Ø§Ø¬Ù’Ø¹ÙÙ„Ù’Ù†ÙÙŠ Ù…ÙÙ†Ù Ø§Ù„Ù’Ù…ÙØªÙÙˆÙÙƒÙÙ‘Ù„ÙÙŠÙ†Ù Ø¹ÙÙ„ÙÙŠÙ’ÙƒÙ", translation: "O Allah, make me among those who rely on You." }
    ];
    
    // Single, universal list of categories
    const BASE_CATEGORIES = [
        'Rent', 'Utilities', 'Groceries', 'Purchase/Bill', 'Debt Payments', 'Insurance', 
        'Tea', 'Food Out', 'Dining Out', 'Entertainment', 'Shopping/Personal', 'Travel', 'Hobbies', 
        'Emergency Fund', 'Investments', 'Retirement', 'Education Fund', 
        'Other'
    ];
    let categories = JSON.parse(localStorage.getItem(KEY_CATEGORIES)) || BASE_CATEGORIES;
    
    let expenses = JSON.parse(localStorage.getItem(KEY_EXP)) || [];
    let history = JSON.parse(localStorage.getItem(KEY_HISTORY)) || []; // Load history
    let totalIncome = Number(localStorage.getItem(KEY_INC)) || 0;
    let allocations = JSON.parse(localStorage.getItem(KEY_ALLOC)) || { needs: 50, wants: 30, savings: 20 };
    
    // DOM Elements
    const totalInput = document.getElementById('total');
    const clearAllBtn = document.getElementById('clearAll');
    const needsEl = document.getElementById('needs');
    const wantsEl = document.getElementById('wants');
    const savingsEl = document.getElementById('savings');
    const totalSummary = document.getElementById('totalSummary');
    const expSection = document.getElementById('expense-section');
    const expCategory = document.getElementById('expense-category');
    const expDate = document.getElementById('expense-date');
    const expAmount = document.getElementById('expense-amount');
    const expNote = document.getElementById('expense-note');
    const tableBody = document.querySelector('#expense-table tbody');
    const topDuaDisplay = document.getElementById('topDuaDisplay');
    const themeToggle = document.getElementById('themeToggle');
    const exportCsvBtn = document.getElementById('exportCsv');
    const archiveMonthBtn = document.getElementById('archiveMonth');
    const historyTableBody = document.getElementById('history-table-body');

    // Modal Elements
    const categoryModal = document.getElementById('categoryModal');
    const manageCategoriesBtn = document.getElementById('manageCategoriesBtn');
    const closeCategoryModalBtn = document.getElementById('closeCategoryModal');
    const newCategoryNameInput = document.getElementById('new-category-name');
    const addCategoryBtn = document.getElementById('addCategoryBtn');
    const currentCategoryList = document.getElementById('currentCategoryList');
    const closeAllocationModalBtn = document.getElementById('closeAllocationModal');
    const allocationModal = document.getElementById('allocationModal');
    const editAllocationsBtn = document.getElementById('editAllocations');
    
    let categoryChart;
    let dailyChart; // Instance for the new daily bar chart

    function init(){
      // Load and apply theme preference first
      const savedTheme = localStorage.getItem(KEY_THEME);
      if (savedTheme === 'dark') {
          document.body.classList.add('dark-mode');
          themeToggle.checked = true;
      } else {
          document.body.classList.remove('dark-mode');
          themeToggle.checked = false;
      }
      
      totalInput.value = totalIncome || '';
      expDate.value = new Date().toISOString().slice(0,10);
      populateCategorySelect();
      renderExpenses();
      
      setupChart(); 
      setupDailyChart(); // Setup the new daily chart
      updateRemaining(); // This calls updateChart() and updateDailyChart()
      renderHistory(); 
      
      displayRandomDua(); // Display Du'a on load
      attachEventListeners();
    }
    
    // --- Theme Toggling ---
    function toggleTheme() {
        document.body.classList.toggle('dark-mode');
        const isDarkMode = document.body.classList.contains('dark-mode');
        localStorage.setItem(KEY_THEME, isDarkMode ? 'dark' : 'light');
        setupChart(); // Recreate chart to pick up new theme colors
        setupDailyChart(); // Recreate daily chart
        updateChart();
        updateDailyChart();
    }

    // --- Du'a Functionality ---
    function displayRandomDua() {
        const randomIndex = Math.floor(Math.random() * ROTATING_DUAS.length);
        const dua = ROTATING_DUAS[randomIndex];
        
        topDuaDisplay.innerHTML = `
            ${dua.arabic}
            <br>(${dua.translation})
        `;
    }

    // --- Data Management & Helper Functions ---
    
    function saveHistory(){ localStorage.setItem(KEY_HISTORY, JSON.stringify(history)); }
    function saveExpenses(){ localStorage.setItem(KEY_EXP, JSON.stringify(expenses)); }
    function saveIncome(){ localStorage.setItem(KEY_INC, String(totalIncome)); }
    function saveAllocations(){ localStorage.setItem(KEY_ALLOC, JSON.stringify(allocations)); }
    function saveCategories(){ localStorage.setItem(KEY_CATEGORIES, JSON.stringify(categories)); }

    function fmt(n){
      if (!isFinite(n)) return '0';
      return 'â‚¹' + Number(n).toLocaleString(undefined, { maximumFractionDigits: 0 });
    }
    
    function formatPercent(value, total) {
        if (total === 0) return '0%';
        return (value / total * 100).toFixed(1) + '%';
    }

    function capitalize(s){ return s.charAt(0).toUpperCase()+s.slice(1); }
    function escapeHtml(s){ return String(s).replace(/[&<>"]/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c])); }
    
    function populateCategorySelect(){
        expCategory.innerHTML = categories.map(cat => 
            `<option value="${cat}">${cat}</option>`
        ).join('');
    }

    // --- Category Management Functions ---
    function renderCategoryList() {
        currentCategoryList.innerHTML = '';
        
        categories.forEach(cat => {
            const listItem = document.createElement('div');
            listItem.className = 'category-list-item';
            
            const isDeletable = cat !== 'Other';
            
            listItem.innerHTML = `
                <span>${cat}</span>
                ${isDeletable ? `<button data-cat="${cat}" class="cat-del-btn danger">Delete</button>` : `<span class="muted" style="font-size: 12px;">(system)</span>`}
            `;
            currentCategoryList.appendChild(listItem);
        });

        currentCategoryList.querySelectorAll('.cat-del-btn').forEach(btn => {
            btn.addEventListener('click', deleteCategory);
        });
    }

    function addCategory() {
        let newCat = newCategoryNameInput.value.trim();

        if (!newCat) { alert('Category name cannot be empty.'); return; }
        newCat = capitalize(newCat);

        if (categories.includes(newCat)) { alert(`Category "${newCat}" already exists.`); return; }

        categories.push(newCat);
        saveCategories();
        newCategoryNameInput.value = '';
        renderCategoryList();
        populateCategorySelect();
        alert(`Category "${newCat}" added.`);
    }

    function deleteCategory(event) {
        const btn = event.target;
        const category = btn.dataset.cat;

        if (!confirm(`Are you sure you want to delete the category "${category}"?`)) return;

        if (category === 'Other') {
            alert("The 'Other' category is required as a catch-all and cannot be deleted.");
            return;
        }

        categories = categories.filter(cat => cat !== category);
        saveCategories();
        renderCategoryList();
        populateCategorySelect(); 
    }

    // --- History Rendering ---
    function renderHistory() {
        historyTableBody.innerHTML = '';
        const monthNames = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
        
        // Reverse order to show most recent first
        history.slice().reverse().forEach(item => {
            const date = new Date(item.date);
            const monthLabel = item.monthLabel || `${monthNames[date.getMonth()]} ${date.getFullYear()}`;
            
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${monthLabel}</td>
                <td>${fmt(item.income)}</td>
                <td>${fmt(item.totalSpent)}</td>
                <td>${fmt(item.netSaved)}</td>
                <td>${item.savingsRate}</td>
            `;
            historyTableBody.appendChild(tr);
        });
    }


    // --- UI Update Functions ---
    
    function updateRemaining(){
      totalIncome = Number(totalInput.value) || totalIncome || 0;
      saveIncome();
      
      const allocP = allocations;
      const allocated = {
        needs: totalIncome * (allocP.needs / 100),
        wants: totalIncome * (allocP.wants / 100),
        savings: totalIncome * (allocP.savings / 100)
      };
      
      let spent = { needs:0, wants:0, savings:0 };
      let totalExpenditure = 0;
      
      expenses.forEach(e => {
          const amount = Number(e.amount);
          spent[e.section] += amount;
          
          // Calculate total expenditure (always positive amount, regardless of section/sign)
          totalExpenditure += Math.abs(amount);
      });
      
      const totalSpent = totalExpenditure;
      
      // totalSavedAmount reflects the base allocation plus net withdrawals
      const totalSavedAmount = allocated.savings + spent.savings; 

      const remainingAfterNeedsWants = totalIncome - totalSpent; 
      const effectiveSavingsRate = formatPercent(totalSavedAmount, totalIncome);
      
      // Update Allocation text
      needsEl.textContent = `Needs (${allocP.needs}%): ${fmt(allocated.needs)} (Remaining: ${fmt(allocated.needs - spent.needs)})`;
      wantsEl.textContent = `Wants (${allocP.wants}%): ${fmt(allocated.wants)} (Remaining: ${fmt(allocated.wants - spent.wants)})`;
      savingsEl.textContent = `Savings (${allocP.savings}%): ${fmt(allocated.savings)} (Current Saved: ${fmt(totalSavedAmount)})`;
      
      // Update Summary text
      totalSummary.textContent = `Total Income: ${fmt(totalIncome)} â€¢ Total Spent: ${fmt(totalSpent)} â€¢ Remaining: ${fmt(remainingAfterNeedsWants)} â€¢ Savings Rate: ${effectiveSavingsRate}`;
      
      updateChart();
      updateDailyChart(); // Call to update the new bar chart
    }

    function renderExpenses(){
      tableBody.innerHTML = '';
      const rows = expenses.slice().sort((a,b) => new Date(b.date) - new Date(a.date));
      rows.forEach(e => {
        const tr = document.createElement('tr');
        
        const amountValue = Number(e.amount);
        let displayAmount;
        
        if (e.section === 'savings') {
             // All savings transactions are withdrawals (negative internal value)
             displayAmount = fmt(Math.abs(amountValue)) + ' (Withdrawal)';
        } else {
            // Needs/Wants are positive.
            displayAmount = fmt(amountValue);
        }

        tr.innerHTML = `
          <td>${e.date}</td>
          <td>${capitalize(e.section)}</td>
          <td>${escapeHtml(e.category)}</td>
          <td>${displayAmount}</td>
          <td><button data-id="${e.id}" class="del-btn danger">Delete</button></td>
        `;
        tableBody.appendChild(tr);
      });
      
      document.querySelectorAll('.del-btn').forEach(btn=>{
        btn.addEventListener('click',()=>{
          expenses = expenses.filter(x=>x.id!==btn.dataset.id);
          saveExpenses(); renderExpenses(); updateRemaining();
        });
      });
    }
    
    // --- Chart Logic ---
    function setupChart() {
        const ctx = document.getElementById('categoryChart').getContext('2d');
        // Destroy any existing chart instance before creating a new one
        if (categoryChart) {
            categoryChart.destroy();
        }

        categoryChart = new Chart(ctx, {
            type: 'pie',
            data: {
                labels: [],
                datasets: [{ data: [], backgroundColor: [], hoverOffset: 4 }]
            },
            options: { 
                responsive: true, 
                plugins: { 
                    legend: { 
                        position: 'top',
                        labels: {
                            color: document.body.classList.contains('dark-mode') ? 'var(--text)' : 'var(--text)'
                        }
                    }, 
                    title: { display: false } 
                } 
            }
        });
    }

    function updateChart() {
        if (!categoryChart) return;
        const categorySpending = {};
        const now = new Date();
        const currentMonth = now.getMonth();
        const currentYear = now.getFullYear();

        expenses.forEach(e => {
            const expenseDate = new Date(e.date + 'T00:00:00'); 
            if (expenseDate.getMonth() === currentMonth && expenseDate.getFullYear() === currentYear) {
                const category = e.category;
                const amount = Number(e.amount);
                
                categorySpending[category] = (categorySpending[category] || 0) + Math.abs(amount);
            }
        });

        const labels = Object.keys(categorySpending);
        const data = Object.values(categorySpending);
        
        const colors = ['#ff6384', '#36a2eb', '#cc65fe', '#ffce56', '#4bc0c0', '#9966ff', '#ff9f40', '#c9cbcf', '#2ecc71', '#e74c3c'];
        const backgroundColors = labels.map((_, i) => colors[i % colors.length]);

        categoryChart.data.labels = labels;
        categoryChart.data.datasets[0].data = data;
        categoryChart.data.datasets[0].backgroundColor = backgroundColors;
        categoryChart.update();
    }

    // --- Daily Bar Chart Logic ---
    function setupDailyChart() {
        const ctx = document.getElementById('dailyChart').getContext('2d');
        if (dailyChart) {
            dailyChart.destroy();
        }

        dailyChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: [],
                datasets: [{
                    label: 'Daily Expenditure (â‚¹)',
                    data: [],
                    backgroundColor: 'var(--accent)',
                    borderColor: 'var(--accent)',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            color: 'var(--muted)'
                        },
                        grid: {
                            color: document.body.classList.contains('dark-mode') ? 'rgba(255,255,255,0.1)' : 'rgba(0,0,0,0.1)'
                        }
                    },
                    x: {
                        ticks: {
                            color: 'var(--muted)'
                        },
                        grid: {
                            display: false
                        }
                    }
                },
                plugins: {
                    legend: {
                        display: false
                    }
                }
            }
        });
    }

    function updateDailyChart() {
        if (!dailyChart) return;

        const dailySpending = {};
        const today = new Date();
        today.setHours(0, 0, 0, 0);

        // 1. Calculate the dates for the last 7 days
        const lastSevenDays = [];
        const dateOptions = { weekday: 'short', day: 'numeric' };

        for (let i = 6; i >= 0; i--) {
            const date = new Date(today);
            date.setDate(today.getDate() - i);
            const dateKey = date.toISOString().slice(0, 10);
            const dateLabel = date.toLocaleDateString('en-US', dateOptions);
            
            lastSevenDays.push({ key: dateKey, label: dateLabel, amount: 0 });
        }

        // 2. Aggregate spending for the last 7 days
        expenses.forEach(e => {
            const expenseDate = new Date(e.date + 'T00:00:00');
            const expenseDateKey = expenseDate.toISOString().slice(0, 10);
            const amount = Math.abs(Number(e.amount)); // Always use absolute expenditure

            // Check if this expense falls within the 7-day range
            const dayEntry = lastSevenDays.find(d => d.key === expenseDateKey);
            if (dayEntry) {
                dayEntry.amount += amount;
            }
        });

        // 3. Prepare Chart Data
        const labels = lastSevenDays.map(d => d.label);
        const data = lastSevenDays.map(d => d.amount);

        // 4. Update and Render
        dailyChart.data.labels = labels;
        dailyChart.data.datasets[0].data = data;
        
        // Update bar color based on theme
        dailyChart.data.datasets[0].backgroundColor = document.body.classList.contains('dark-mode') ? '#5e64ff' : '#007bff';
        dailyChart.data.datasets[0].borderColor = document.body.classList.contains('dark-mode') ? '#a0a0c0' : '#333';


        dailyChart.update();
    }

    
    // --- Export to CSV Function ---
    function exportToCsv() {
        // --- 1. Build Historical Summary Header ---
        let csv = 'Historical Monthly Summaries\n';
        csv += 'Month,Income,Spent (Total),Net Savings,Savings Rate\n';
        
        history.forEach(item => {
            csv += [
                item.monthLabel.replace(/,/g, ''), 
                item.income.toFixed(2),
                item.totalSpent.toFixed(2),
                item.netSaved.toFixed(2),
                item.savingsRate
            ].join(',') + '\n';
        });

        csv += '\n-------------------------------------------------\n\n';
        
        // --- 2. Gather Current Month Summary Data ---
        const allocated = {
            needs: totalIncome * (allocations.needs / 100),
            wants: totalIncome * (allocations.wants / 100),
            savings: totalIncome * (allocations.savings / 100)
        };
        
        let netSpent = { needs:0, wants:0, savings:0 };
        expenses.forEach(e => netSpent[e.section] += Number(e.amount));
        
        const totalSpent = (Math.abs(netSpent.needs) + Math.abs(netSpent.wants) + Math.abs(netSpent.savings));
        const totalSavedAmount = allocated.savings + netSpent.savings;
        const remaining = totalIncome - totalSpent;
        const savingsRate = formatPercent(totalSavedAmount, totalIncome);

        // --- 3. Build Current Month Summary ---
        csv += 'Current Month Summary\n';
        csv += `Total Income,${totalIncome.toFixed(2)}\n`;
        csv += `Total Spent,${totalSpent.toFixed(2)}\n`;
        csv += `Remaining (Income - Spent),${remaining.toFixed(2)}\n`;
        csv += `Savings Rate,${savingsRate}\n`;
        csv += 'Allocations,Percentage,Target Amount,Spent Amount,Remaining Budget\n';
        
        // Add allocation rows
        csv += `Needs,${allocations.needs}%,${allocated.needs.toFixed(2)},${(Math.abs(netSpent.needs)).toFixed(2)},${(allocated.needs - Math.abs(netSpent.needs)).toFixed(2)}\n`;
        csv += `Wants,${allocations.wants}%,${allocated.wants.toFixed(2)},${(Math.abs(netSpent.wants)).toFixed(2)},${(allocated.wants - Math.abs(netSpent.wants)).toFixed(2)}\n`;
        csv += `Savings (Net),${allocations.savings}%,${allocated.savings.toFixed(2)},${totalSavedAmount.toFixed(2)},N/A\n`;

        csv += '\nTransaction History\n';
        
        // --- 4. Build Current Transaction Data ---
        if (expenses.length === 0) {
            csv += 'No current month transactions recorded.\n';
        } else {
            // Define CSV headers for transactions
            csv += 'Date,Section,Category,Amount,Note,Type\n';

            expenses.forEach(e => {
                const amount = Number(e.amount);
                const type = e.section === 'savings' && amount < 0 ? 'Withdrawal' : 'Expense';
                
                // NOTE: Use '="date"' format for dates to force Excel to treat it as text/string
                const cleanDate = `="${e.date}"`; 
                const cleanNote = (e.note || '').replace(/,/g, ';').replace(/"/g, '""'); 
                
                csv += [
                    cleanDate, 
                    capitalize(e.section),
                    e.category,
                    Math.abs(amount).toFixed(2), // Export absolute value
                    `"${cleanNote}"`, // Wrap note in quotes
                    type
                ].join(',') + '\n';
            });
        }
        

        // --- 5. Trigger Download ---
        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        
        const link = document.createElement('a');
        link.href = url;
        link.setAttribute('download', `budget_report_${new Date().toISOString().slice(0,10)}.csv`);
        
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(url);
    }

    // --- Archive Functionality ---
    function handleArchiveMonth(skipConfirm = false, archiveDate = new Date()) {
        if (!skipConfirm && !confirm("Are you sure you want to archive the current month and reset transactions?")) return;

        // 1. Calculate final snapshot values
        const allocP = allocations;
        const allocated = {
            needs: totalIncome * (allocP.needs / 100),
            wants: totalIncome * (allocP.wants / 100),
            savings: totalIncome * (allocP.savings / 100)
        };
        
        let netSpent = { needs:0, wants:0, savings:0 };
        expenses.forEach(e => netSpent[e.section] += Number(e.amount));
        
        const totalSpent = (Math.abs(netSpent.needs) + Math.abs(netSpent.wants) + Math.abs(netSpent.savings));
        const totalSavedAmount = allocated.savings + netSpent.savings;
        const savingsRate = formatPercent(totalSavedAmount, totalIncome);
        
        // 2. Determine Month Label
        const dateToLabel = archiveDate || new Date();
        const monthLabel = dateToLabel.toLocaleString('default', { month: 'long', year: 'numeric' });

        // 3. Create History Object
        const historyEntry = {
            id: Date.now(),
            date: dateToLabel.toISOString(),
            monthLabel: monthLabel,
            income: totalIncome,
            totalSpent: totalSpent,
            netSaved: totalSavedAmount,
            savingsRate: savingsRate,
        };
        
        // 4. Save to History
        history.push(historyEntry);
        saveHistory();

        // 5. Reset Current State (Keep Income, Clear Expenses)
        expenses = [];
        saveExpenses();
        
        // 6. Update UI
        expDate.value = new Date().toISOString().slice(0,10);
        
        renderExpenses();
        updateRemaining();
        renderHistory();
        alert(`${monthLabel} archived successfully! Starting new budget period.`);
    }


    // --- Event Listeners and Handlers ---

    function attachEventListeners() {
      // Theme Toggle Listener
      document.getElementById('themeToggle').addEventListener('change', toggleTheme);
      
      document.getElementById('expense-section').addEventListener('change', populateCategorySelect);
      document.getElementById('add-expense').addEventListener('click', handleAddExpense);
      document.getElementById('saveIncome').addEventListener('click', handleSaveIncome);
      clearAllBtn.addEventListener('click', handleClearAll);
      
      // Archive Listener
      archiveMonthBtn.addEventListener('click', () => handleArchiveMonth(false, new Date())); 
      
      // CSV Listener
      exportCsvBtn.addEventListener('click', exportToCsv); 
      
      // Allocation Modal Listeners
      document.getElementById('editAllocations').onclick = handleEditAllocations;
      document.getElementById('closeAllocationModal').onclick = () => { allocationModal.style.display = "none"; };
      document.getElementById('savePercentages').onclick = handleSavePercentages;
      
      // Category Management Modal Listeners
      document.getElementById('manageCategoriesBtn').onclick = handleManageCategories;
      document.getElementById('closeCategoryModal').onclick = () => { categoryModal.style.display = "none"; };
      document.getElementById('addCategoryBtn').onclick = addCategory;

      // Close Modals on outside click
      window.onclick = function(event) { 
          if (event.target == allocationModal) { allocationModal.style.display = "none"; }
          if (event.target == categoryModal) { categoryModal.style.display = "none"; }
      }

      // Import/Export Listeners
      document.getElementById('exportData').addEventListener('click', handleExportData);
      document.getElementById('importData').addEventListener('click', () => { document.getElementById('importFile').click(); });
      document.getElementById('importFile').addEventListener('change', handleImportData);
    }
    
    // Event Handlers
    function handleAddExpense() {
        const section = expSection.value.toLowerCase();
        const category = expCategory.value;
        let amount = Number(expAmount.value);
        const dateVal = expDate.value || new Date().toISOString().slice(0,10);
        const note = expNote.value || '';
        
        if (!isFinite(amount) || amount <= 0) { 
             alert('Enter a valid positive amount.'); 
             return; 
        }
        if (!category){ alert('Please select a category'); return; }

        // If section is 'savings', record the positive input as a negative withdrawal
        if (section === 'savings') {
            amount = -Math.abs(amount); 
        }

        const id = String(Date.now()) + Math.random().toString(36).slice(2,6);
        expenses.push({ id, date: dateVal, section, category, amount, note });
        
        saveExpenses();
        expAmount.value=''; expNote.value='';
        expDate.value = new Date().toISOString().slice(0,10);
        renderExpenses(); updateRemaining();
    }

    function handleSaveIncome() {
        const val = Number(document.getElementById('total').value);
        if (!isFinite(val)||val<0){ alert('Enter valid income'); return; }
        totalIncome=val; saveIncome(); updateRemaining();
    }

    function handleClearAll() {
        if(!confirm('Clear ALL data? (Income, Expenses, Allocations, History, and Custom Categories)')) return;
        expenses=[]; totalIncome=0; allocations = { needs: 50, wants: 30, savings: 20 }; categories = BASE_CATEGORIES; history=[];
        localStorage.clear();
        document.getElementById('total').value=''; renderExpenses(); updateRemaining(); renderHistory();
        populateCategorySelect();
    }
    
    function handleEditAllocations() {
        document.getElementById('needs-percent').value = allocations.needs;
        document.getElementById('wants-percent').value = allocations.wants;
        document.getElementById('savings-percent').value = allocations.savings;
        allocationModal.style.display = "block";
    }

    function handleSavePercentages() {
        const n = Number(document.getElementById('needs-percent').value) || 0;
        const w = Number(document.getElementById('wants-percent').value) || 0;
        const s = Number(document.getElementById('savings-percent').value) || 0;
        
        if (n + w + s !== 100) { alert('The percentages must total 100%.'); return; }
        if (n < 0 || w < 0 || s < 0) { alert('Percentages must be non-negative.'); return; }

        allocations = { needs: n, wants: w, savings: s };
        saveAllocations();
        updateRemaining();
        allocationModal.style.display = "none";
        alert('New allocations saved!');
    }

    function handleManageCategories() {
        categoryModal.style.display = "block";
        renderCategoryList();
    }

    function handleExportData() {
        const data = { totalIncome: totalIncome, allocations: allocations, expenses: expenses, categories: categories, history: history };
        const json = JSON.stringify(data, null, 2);
        const blob = new Blob([json], {type: 'application/json'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'budget_data_' + new Date().toISOString().slice(0,10) + '.json';
        document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url);
    }

    function handleImportData(event) {
        const file = event.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const importedData = JSON.parse(e.target.result);
                if (!confirm('This will overwrite all current data. Continue?')) return;

                if (importedData.totalIncome !== undefined) totalIncome = Number(importedData.totalIncome) || 0;
                if (importedData.allocations) allocations = importedData.allocations;
                if (importedData.expenses) expenses = importedData.expenses;
                if (importedData.history) history = importedData.history;
                
                categories = importedData.categories || BASE_CATEGORIES;
                if (!categories.includes('Other')) categories.push('Other');

                saveIncome(); saveAllocations(); saveExpenses(); saveCategories(); saveHistory();
                
                document.getElementById('total').value = totalIncome;
                renderExpenses(); updateRemaining(); renderHistory(); populateCategorySelect();
                alert('Data imported successfully!');
            } catch (error) {
                alert('Error importing data. Please ensure the file is a valid JSON budget file.');
                console.error('Import error:', error);
            }
        };
        reader.readAsText(file);
    }

    init();
  </script>
</body>
</html>
